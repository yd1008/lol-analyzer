{% extends "base.html" %}

{% block title %}Test LLM - Admin{% endblock %}

{% block content %}
<div class="container dashboard">
    <div class="dashboard-header">
        <h1>Test LLM Analysis <span class="admin-badge">Admin</span></h1>
        <a href="{{ url_for('admin.index') }}" class="btn btn-secondary btn-sm">Back to Admin</a>
    </div>

    <!-- Step 1: Look up summoner -->
    <div class="admin-card">
        <h3>Step 1: Look Up Summoner</h3>
        <p>Enter a summoner name to fetch their recent matches.</p>
        <form method="POST" class="loading-form admin-lookup-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="lookup">
            <div class="admin-lookup-grid">
                <div class="form-group compact-field">
                    <label>Summoner Name</label>
                    <input type="text" name="summoner_name" placeholder="e.g. Faker" value="{{ summoner_name or '' }}" required>
                </div>
                <div class="form-group compact-field">
                    <label>Tagline</label>
                    <input type="text" name="tagline" placeholder="e.g. KR1" value="{{ tagline or '' }}" required>
                </div>
                <div class="form-group compact-field">
                    <label>Region</label>
                    <select name="region">
                        {% for r in ['na1','euw1','eun1','kr','br1','la1','la2','oc1','tr1','ru','jp1'] %}
                        <option value="{{ r }}" {{ 'selected' if region == r }}>{{ r.upper() }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm admin-form-submit">Fetch Matches</button>
        </form>
    </div>

    {% if match_list %}
    <!-- Step 2: Select a match -->
    <div class="admin-card">
        <h3>Step 2: Select a Match</h3>
        <p>Choose a match to analyze with the LLM.</p>
        <table class="match-select-table">
            <thead>
                <tr>
                    <th>Champion</th>
                    <th>Result</th>
                    <th>KDA</th>
                    <th>Duration</th>
                    <th>Queue</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for match in match_list %}
                <tr>
                    <td>{{ match.champion }}</td>
                    <td><span class="{{ 'win' if match.win else 'loss' }}">{{ 'Win' if match.win else 'Loss' }}</span></td>
                    <td>{{ match.kills }}/{{ match.deaths }}/{{ match.assists }}</td>
                    <td>{{ match.game_duration }} min</td>
                    <td>{{ match.queue_type }}</td>
                    <td>
                        <form method="POST" class="loading-form inline-action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="select">
                            <input type="hidden" name="match_id" value="{{ match.match_id }}">
                            <input type="hidden" name="puuid" value="{{ puuid }}">
                            <input type="hidden" name="region" value="{{ region }}">
                            <input type="hidden" name="summoner_name" value="{{ summoner_name }}">
                            <input type="hidden" name="tagline" value="{{ tagline }}">
                            <button type="submit" class="btn btn-primary btn-sm">Select</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if analysis_data %}
    <!-- Step 3: Match data preview -->
    <div class="admin-card">
        <h3>Step 3: Match Data</h3>
        <div class="match-stats-grid admin-preview-grid">
            <div class="stat-card">
                <div class="stat-label">Champion</div>
                <div class="stat-value stat-value-lg">{{ analysis_data.champion }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Result</div>
                <div class="stat-value stat-value-lg {{ 'win' if analysis_data.win else 'loss' }}">{{ 'Win' if analysis_data.win else 'Loss' }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">KDA</div>
                <div class="stat-value stat-value-lg">{{ analysis_data.kills }}/{{ analysis_data.deaths }}/{{ analysis_data.assists }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Gold/min</div>
                <div class="stat-value stat-value-lg">{{ analysis_data.gold_per_min }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">DMG/min</div>
                <div class="stat-value stat-value-lg">{{ analysis_data.damage_per_min }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Vision</div>
                <div class="stat-value stat-value-lg">{{ analysis_data.vision_score }}</div>
            </div>
        </div>

        <!-- Step 4: Run LLM -->
        <form method="POST" id="llm-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="run_llm">
            <input type="hidden" name="analysis_json" value='{{ analysis_data | tojson }}'>
            <button type="submit" class="btn btn-primary btn-sm" id="llm-btn">Run LLM Analysis</button>
        </form>
        <div id="llm-loading" class="loading-indicator">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <strong>Generating AI analysis...</strong>
                <span class="loading-subtext">This may take 30-60 seconds with reasoning models</span>
            </div>
        </div>
    </div>
    {% endif %}

    {% if result %}
    <!-- Step 5: LLM Result -->
    <div class="admin-card">
        <h3>Step 4: LLM Output</h3>
        <div class="admin-result">{{ result }}</div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Loading state for LLM form
    var llmForm = document.getElementById('llm-form');
    if (llmForm) {
        llmForm.addEventListener('submit', function() {
            var btn = document.getElementById('llm-btn');
            var loading = document.getElementById('llm-loading');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            btn.style.opacity = '0.5';
            loading.style.display = 'flex';
        });
    }

    // Loading state for all forms with class loading-form
    document.querySelectorAll('.loading-form').forEach(function(form) {
        form.addEventListener('submit', function() {
            var btn = form.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Loading...';
                btn.style.opacity = '0.5';
            }
        });
    });
});
</script>
{% endblock %}
