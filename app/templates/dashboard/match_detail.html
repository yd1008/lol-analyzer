{% extends "base.html" %}

{% block title %}{{ analysis.champion }} - Match Detail{% endblock %}

{% block content %}
<div class="container dashboard">
    <div class="match-detail-header">
        <div class="match-headline">
            <div class="page-eyebrow">Match Breakdown</div>
            <h1>{{ analysis.champion }}</h1>
            <div class="match-head-meta">
                <span class="match-result {{ 'win' if analysis.win else 'loss' }}">
                    {{ 'Victory' if analysis.win else 'Defeat' }}
                </span>
                <span class="match-date">{{ analysis.analyzed_at.strftime('%b %d, %Y at %H:%M') }}</span>
            </div>
        </div>
        <a href="{{ url_for('dashboard.matches') }}" class="btn btn-secondary btn-sm">Back</a>
    </div>

    <div class="card page-usage">
        <h3>Read This Match in 3 Moves</h3>
        <div class="quick-guide-grid">
            <div class="quick-guide-step"><span>1</span>Start in Overview for comp and lane context.</div>
            <div class="quick-guide-step"><span>2</span>Use Visuals to compare against team and lobby baselines.</div>
            <div class="quick-guide-step"><span>3</span>Run AI Analysis and apply one focus next queue.</div>
        </div>
    </div>

    <div class="detail-tabs" id="detail-tabs" role="tablist" aria-label="Match detail sections">
        <button class="detail-tab-btn active" id="detail-tab-overview" data-tab="overview" role="tab" aria-selected="true" aria-controls="detail-panel-overview">Overview</button>
        <button class="detail-tab-btn" id="detail-tab-visuals" data-tab="visuals" role="tab" aria-selected="false" aria-controls="detail-panel-visuals" tabindex="-1">Visuals</button>
        <button class="detail-tab-btn" id="detail-tab-ai" data-tab="ai" role="tab" aria-selected="false" aria-controls="detail-panel-ai" tabindex="-1">AI Analysis</button>
    </div>

    <div class="detail-tab-stage">
        <div class="detail-tab-panel active" id="detail-panel-overview" data-panel="overview" role="tabpanel" aria-labelledby="detail-tab-overview">
            <div class="match-stats-grid">
                <div class="stat-card">
                    <div class="stat-label">KDA</div>
                    <div class="stat-value">{{ analysis.kills }}/{{ analysis.deaths }}/{{ analysis.assists }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">KDA Ratio</div>
                    <div class="stat-value">{{ analysis.kda }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gold</div>
                    <div class="stat-value">{{ analysis.gold_per_min }}/m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Damage</div>
                    <div class="stat-value">{{ analysis.damage_per_min }}/m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Vision</div>
                    <div class="stat-value">{{ analysis.vision_score }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CS</div>
                    <div class="stat-value">{{ analysis.cs_total }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value">{{ analysis.game_duration }}m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gold Total</div>
                    <div class="stat-value">{{ '{:,}'.format(analysis.gold_earned or 0) }}</div>
                </div>
            </div>

            <div class="card">
                <h3>Team Compositions</h3>
                <div class="team-composition-dual">
                    <div class="team-comp-block">
                        <div class="team-comp-title">Allies</div>
                        <div class="team-comp-icons">
                            {% for p in match_view.ally_comp %}
                            <div class="team-comp-icon-wrap" title="{{ p.summoner_name }}{% if p.tagline %}#{{ p.tagline }}{% endif %} | {{ p.champion }} | {{ p.kills }}/{{ p.deaths }}/{{ p.assists }}">
                                {% if p.champion_icon %}
                                <img class="champion-icon" src="{{ p.champion_icon }}" alt="{{ p.champion }}">
                                {% else %}
                                <span class="champion-icon-fallback">{{ p.champion[:1] }}</span>
                                {% endif %}
                                <span class="lane-mini">{{ p.lane_label }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="team-comp-block">
                        <div class="team-comp-title">Enemies</div>
                        <div class="team-comp-icons">
                            {% for p in match_view.enemy_comp %}
                            <div class="team-comp-icon-wrap" title="{{ p.summoner_name }}{% if p.tagline %}#{{ p.tagline }}{% endif %} | {{ p.champion }} | {{ p.kills }}/{{ p.deaths }}/{{ p.assists }}">
                                {% if p.champion_icon %}
                                <img class="champion-icon" src="{{ p.champion_icon }}" alt="{{ p.champion }}">
                                {% else %}
                                <span class="champion-icon-fallback">{{ p.champion[:1] }}</span>
                                {% endif %}
                                <span class="lane-mini">{{ p.lane_label }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Lane-by-Lane Matchup</h3>
                <div class="lane-grid">
                    {% for lane in match_view.lane_matchups %}
                    <div class="lane-row">
                        <div class="lane-row-label">{{ lane.lane_label }}</div>
                        <div class="lane-player ally">
                            {% if lane.ally %}
                                {% if lane.ally.champion_icon %}
                                <img class="champion-icon champion-icon-sm" src="{{ lane.ally.champion_icon }}" alt="{{ lane.ally.champion }}">
                                {% else %}
                                <span class="champion-icon-fallback champion-icon-sm">{{ lane.ally.champion[:1] }}</span>
                                {% endif %}
                                <div>
                                    <div class="lane-player-name">{{ lane.ally.summoner_name or lane.ally.champion }}</div>
                                    <div class="lane-player-sub">{{ lane.ally.champion }} | {{ lane.ally.kills }}/{{ lane.ally.deaths }}/{{ lane.ally.assists }}</div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="lane-player enemy">
                            {% if lane.enemy %}
                                {% if lane.enemy.champion_icon %}
                                <img class="champion-icon champion-icon-sm" src="{{ lane.enemy.champion_icon }}" alt="{{ lane.enemy.champion }}">
                                {% else %}
                                <span class="champion-icon-fallback champion-icon-sm">{{ lane.enemy.champion[:1] }}</span>
                                {% endif %}
                                <div>
                                    <div class="lane-player-name">{{ lane.enemy.summoner_name or lane.enemy.champion }}</div>
                                    <div class="lane-player-sub">{{ lane.enemy.champion }} | {{ lane.enemy.kills }}/{{ lane.enemy.deaths }}/{{ lane.enemy.assists }}</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <h3>Full Match Summary</h3>
                <div class="match-summary-table-wrap">
                    <table class="match-summary-table">
                        <thead>
                            <tr>
                                <th>Side</th>
                                <th>Champion</th>
                                <th>Runes</th>
                                <th>KDA</th>
                                <th>Damage</th>
                                <th>Wards</th>
                                <th>CS</th>
                                <th>Items</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in match_view.scoreboard_rows %}
                            <tr class="{{ 'ally' if row.side == 'ALLY' else 'enemy' }}">
                                <td>{{ row.side }}</td>
                                <td>
                                    <div class="summary-champion-cell">
                                        {% if row.champion_icon %}
                                        <img class="champion-icon champion-icon-sm" src="{{ row.champion_icon }}" alt="{{ row.champion }}">
                                        {% else %}
                                        <span class="champion-icon-fallback champion-icon-sm">{{ row.champion[:1] }}</span>
                                        {% endif %}
                                        <div>
                                            <div class="summary-primary">{{ row.champion }}</div>
                                            <div class="summary-sub">{{ row.summoner_name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="summary-runes">
                                        {% if row.runes.primary %}
                                        <img class="rune-icon" src="{{ row.runes.primary }}" alt="Primary rune">
                                        {% else %}
                                        <span class="rune-fallback">P</span>
                                        {% endif %}
                                        {% if row.runes.secondary %}
                                        <img class="rune-icon" src="{{ row.runes.secondary }}" alt="Secondary rune">
                                        {% else %}
                                        <span class="rune-fallback">S</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>{{ row.kills }}/{{ row.deaths }}/{{ row.assists }}</td>
                                <td>
                                    <div class="damage-cell">
                                        <div class="damage-track"><div class="damage-fill" style="width: {{ row.damage_pct }}%"></div></div>
                                        <span>{{ row.total_damage }}</span>
                                    </div>
                                </td>
                                <td>{{ row.vision_score }}</td>
                                <td>{{ row.cs }}</td>
                                <td>
                                    <div class="summary-items">
                                        {% for it in row['items'] %}
                                            {% if it.icon %}
                                            <img class="item-icon" src="{{ it.icon }}" alt="Item {{ it.id }}">
                                            {% else %}
                                            <span class="item-fallback">{{ it.id }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if analysis.recommendations %}
            <div class="card">
                <h3>Quick Recommendations</h3>
                <ul class="recommendations-list">
                    {% for rec in analysis.recommendations %}
                    <li>{{ rec }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

        <div class="detail-tab-panel" id="detail-panel-visuals" data-panel="visuals" role="tabpanel" aria-labelledby="detail-tab-visuals" hidden>
            <div class="card">
                <h3>Performance Visuals</h3>
                <div class="visual-toggle-bar" id="detail-visual-toggle" role="tablist" aria-label="Visualization groups">
                    <button class="visual-toggle-btn active" id="detail-visual-tab-compare" data-group="compare" role="tab" aria-selected="true" aria-controls="detail-visual-group-compare">Compare</button>
                    <button class="visual-toggle-btn" id="detail-visual-tab-shares" data-group="shares" role="tab" aria-selected="false" aria-controls="detail-visual-group-shares" tabindex="-1">Shares</button>
                    <button class="visual-toggle-btn" id="detail-visual-tab-lane" data-group="lane" role="tab" aria-selected="false" aria-controls="detail-visual-group-lane" tabindex="-1">Lane</button>
                </div>

                <div class="visual-group active" id="detail-visual-group-compare" data-group="compare" role="tabpanel" aria-labelledby="detail-visual-tab-compare">
                    <div class="visuals-grid">
                        {% set visual_labels = {'gold_per_min': 'Gold / Min', 'damage_per_min': 'Damage / Min', 'cs_per_min': 'CS / Min', 'vision_per_min': 'Vision / Min', 'kda': 'KDA'} %}
                        {% for metric, label in visual_labels.items() %}
                        {% set player = match_view.visuals.player.get(metric, 0) %}
                        {% set team_avg = match_view.visuals.team_avg.get(metric, 0) %}
                        {% set lobby_avg = match_view.visuals.lobby_avg.get(metric, 0) %}
                        {% set maxv = [player, team_avg, lobby_avg, 1] | max %}
                        <div class="visual-row">
                            <div class="visual-label">{{ label }}</div>
                            <div class="visual-bars">
                                <div class="visual-bar-track">
                                    <div class="visual-bar player" style="width: {{ ((player / maxv) * 100) | round(1) }}%"></div>
                                </div>
                                <div class="visual-bar-values">
                                    <span>You: {{ player }}</span>
                                    <span>Team Avg: {{ team_avg }}</span>
                                    <span>Lobby Avg: {{ lobby_avg }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="visual-group" id="detail-visual-group-shares" data-group="shares" role="tabpanel" aria-labelledby="detail-visual-tab-shares" hidden>
                    {% set shares = match_view.visuals.shares %}
                    <div class="share-grid">
                        {% for key, label in [('gold_share_pct','Gold Share'), ('damage_share_pct','Damage Share'), ('cs_share_pct','CS Share'), ('vision_share_pct','Vision Share'), ('kill_participation_pct','Kill Part.')] %}
                        {% set value = shares.get(key, 0) %}
                        <div class="share-card">
                            <div class="share-ring" style="--pct: {{ value }};"><span>{{ value }}%</span></div>
                            <div class="share-label">{{ label }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="visual-group" id="detail-visual-group-lane" data-group="lane" role="tabpanel" aria-labelledby="detail-visual-tab-lane" hidden>
                    {% set lane = match_view.visuals.lane %}
                    {% if lane and lane.get('opponent') %}
                    <div class="lane-chart-head">
                        {% if lane.opponent.champion_icon %}
                        <img class="champion-icon champion-icon-sm" src="{{ lane.opponent.champion_icon }}" alt="{{ lane.opponent.champion }}">
                        {% endif %}
                        <span>Lane vs {{ lane.opponent.champion }}</span>
                    </div>
                    <div class="lane-delta-grid">
                        {% for key, label in [('gpm_delta','Gold/min Delta'), ('dpm_delta','Damage/min Delta'), ('cspm_delta','CS/min Delta'), ('vpm_delta','Vision/min Delta'), ('kda_delta','KDA Delta')] %}
                        {% set value = lane.get(key, 0) %}
                        {% set width = [value|abs * 12, 100] | min %}
                        <div class="lane-delta-row">
                            <div class="lane-delta-label">{{ label }}</div>
                            <div class="lane-delta-track">
                                <div class="lane-delta-bar {{ 'positive' if value >= 0 else 'negative' }}" style="width: {{ width }}%"></div>
                            </div>
                            <div class="lane-delta-value {{ 'positive' if value >= 0 else 'negative' }}">{{ '+' if value >= 0 else '' }}{{ value }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="card-muted">No direct lane opponent data in this match.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="detail-tab-panel" id="detail-panel-ai" data-panel="ai" role="tabpanel" aria-labelledby="detail-tab-ai" hidden>
            <div class="card">
                <h3>AI Match Analysis</h3>
                <div id="detail-ai-content" class="detail-ai-scroll">
                    <p class="card-muted">Run AI analysis to generate matchup-specific coaching.</p>
                </div>
                <button class="ai-btn{{ ' has-analysis' if analysis.llm_analysis else '' }}" id="detail-ai-btn" data-match-id="{{ analysis.id }}">
                    {{ 'Regenerate AI Analysis' if analysis.llm_analysis else 'Run AI Analysis' }}
                </button>
                <script type="application/json" id="detail-ai-initial">{{ (analysis.llm_analysis or '') | tojson }}</script>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var tabs = document.getElementById('detail-tabs');
    var panels = document.querySelectorAll('.detail-tab-panel');
    var visualToggle = document.getElementById('detail-visual-toggle');
    var csrf = document.querySelector('meta[name="csrf-token"]');
    csrf = csrf ? csrf.getAttribute('content') : '';

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function normalizeAiText(text) {
        var normalized = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        normalized = normalized.replace(/^\s{0,3}#{1,6}\s*/gm, '');
        normalized = normalized.replace(/^\s*>\s?/gm, '');
        normalized = normalized.replace(/^\s*[-*+]\s+/gm, '');
        normalized = normalized.replace(/^\s*\d+[.)]\s+/gm, '');
        normalized = normalized.replace(/\*\*(.*?)\*\*/g, '$1');
        normalized = normalized.replace(/__(.*?)__/g, '$1');
        normalized = normalized.replace(/`([^`]+)`/g, '$1');
        normalized = normalized.replace(/[*_]{1,3}([^*_]+)[*_]{1,3}/g, '$1');
        normalized = normalized.replace(/\n{3,}/g, '\n\n');
        return normalized.trim();
    }

    function renderAiText(container, text) {
        container.innerHTML = '';
        var node = document.createElement('div');
        node.className = 'llm-analysis';
        node.textContent = normalizeAiText(text);
        container.appendChild(node);
    }

    function syncTabState(buttons, panels, activeKey, buttonAttr, panelAttr) {
        buttons.forEach(function (button) {
            var isActive = button.getAttribute(buttonAttr) === activeKey;
            button.classList.toggle('active', isActive);
            button.setAttribute('aria-selected', isActive ? 'true' : 'false');
            // Keep all tab buttons in the keyboard tab order.
            button.tabIndex = 0;
        });
        panels.forEach(function (panel) {
            var isActive = panel.getAttribute(panelAttr) === activeKey;
            panel.classList.toggle('active', isActive);
            panel.hidden = !isActive;
        });
    }

    function activateTab(tab) {
        if (!tabs) return;
        var buttons = tabs.querySelectorAll('.detail-tab-btn');
        syncTabState(buttons, panels, tab, 'data-tab', 'data-panel');
    }

    function activateVisual(group) {
        if (!visualToggle) return;
        var toggleButtons = visualToggle.querySelectorAll('.visual-toggle-btn');
        var visualPanel = visualToggle.closest('.card');
        if (!visualPanel) return;
        var groups = visualPanel.querySelectorAll('.visual-group');
        syncTabState(toggleButtons, groups, group, 'data-group', 'data-group');
    }

    if (tabs) {
        tabs.addEventListener('click', function (e) {
            var btn = e.target.closest('.detail-tab-btn');
            if (!btn) return;
            activateTab(btn.getAttribute('data-tab'));
        });
    }

    if (visualToggle) {
        visualToggle.addEventListener('click', function (e) {
            var btn = e.target.closest('.visual-toggle-btn');
            if (!btn) return;
            activateVisual(btn.getAttribute('data-group'));
        });
    }

    activateTab('overview');
    activateVisual('compare');

    var aiBtn = document.getElementById('detail-ai-btn');
    var aiContent = document.getElementById('detail-ai-content');
    var initial = document.getElementById('detail-ai-initial');
    if (aiBtn && aiContent && initial) {
        var initialText = '';
        try {
            initialText = JSON.parse(initial.textContent || '""');
        } catch (e) {
            initialText = '';
        }
        if (initialText) {
            renderAiText(aiContent, initialText);
            aiBtn.classList.add('has-analysis');
            aiBtn.textContent = 'Regenerate AI Analysis';
        }

        aiBtn.addEventListener('click', function () {
            var matchId = aiBtn.getAttribute('data-match-id');
            var force = aiBtn.classList.contains('has-analysis');
            aiBtn.disabled = true;
            aiBtn.textContent = 'Analyzing...';
            fetch('/dashboard/api/matches/' + matchId + '/ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf,
                },
                body: JSON.stringify({force: force}),
            })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.error && !data.analysis) {
                        aiContent.className = 'detail-ai-scroll';
                        aiContent.innerHTML = '<p class="card-muted">' + escapeHtml(data.error || 'AI analysis failed.') + '</p>';
                        aiBtn.disabled = false;
                        aiBtn.textContent = 'Run AI Analysis';
                        return;
                    }
                    renderAiText(aiContent, data.analysis || '');
                    if (data.stale && data.error) {
                        var staleNode = document.createElement('p');
                        staleNode.className = 'card-muted';
                        staleNode.textContent = 'Using cached analysis because regeneration failed: ' + (data.error || '');
                        aiContent.appendChild(staleNode);
                    }
                    aiBtn.disabled = false;
                    aiBtn.classList.add('has-analysis');
                    aiBtn.textContent = 'Regenerate AI Analysis';
                })
                .catch(function () {
                    aiBtn.disabled = false;
                    aiBtn.textContent = 'Run AI Analysis';
                });
        });
    }
});
</script>
{% endblock %}
